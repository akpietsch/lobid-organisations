@* Copyright 2014-2016, hbz. Licensed under the Eclipse Public License 1.0 *@

@(id: String, content: com.fasterxml.jackson.databind.JsonNode, hasLocation: Boolean)

@import play.api.libs.json._
@import play.i18n._

@main("", scripts = if(hasLocation){makeLocationDetails()}else{Html("")}) {
    @defining(Json.parse(content.toString())) { parsedContent =>
    <h1>@((parsedContent \ controllers.Application.localized("name", content)).asOpt[String].getOrElse(id))</h1>
    <p>
      <div class="row">
        <div class="col-md-@if(hasLocation){6}else{12}">
          <p>
          <table class='table table-striped table-condensed'>
              @produceRow(Messages.get("organisation.table.isil"), parsedContent \ "isil", false)
              @produceRow(Messages.get("organisation.table.dbsID"), parsedContent \ "dbsID", false)
              @produceRow(Messages.get("organisation.table.wikipedia"), parsedContent \ "wikipedia", true)
              @produceRow(Messages.get("organisation.table.url"), parsedContent \ "url", true)
              @produceRow(Messages.get("organisation.table.telephone"), parsedContent \ "telephone", false)
              @produceRow(Messages.get("organisation.table.email"), parsedContent \ "email", true)
              @produceRow(Messages.get("organisation.table.type"), parsedContent \ "type", false)
              @produceRow(Messages.get("organisation.table.classification"), parsedContent \ "classification" \ "label", false)
              @produceRow(Messages.get("organisation.table.fundertype"), parsedContent \ "fundertype" \ "label", false)
              @produceRow(Messages.get("organisation.table.stocksize"), parsedContent \ "stocksize" \ "label", false)

              @for(alternateName <- (parsedContent \ "alternateName").asOpt[Seq[JsValue]].getOrElse(Seq())) {
                   @produceRow(Messages.get("organisation.table.alternateName"), alternateName, false)
              }
          </table>
          </p>
        </div>
        @if(hasLocation){
          <div class="col-md-6">
            <p>
                @if((parsedContent \ "location").asOpt[Seq[JsValue]].getOrElse(Seq()).length > 1
                  || ((parsedContent \ "location").asOpt[Seq[JsValue]].getOrElse(Seq()).length == 1
                     && (parsedContent \ "address").asOpt[JsObject].isDefined)) {
                  <ul class="nav nav-tabs">
                  @for(i <- 0 to (parsedContent \ "location").asOpt[Seq[JsValue]].getOrElse(Seq()).length-1) {
                    @if(i == 0) {
                      <li class="active"><a href="#organisations-map@i" data-toggle="tab">@Messages.get("organisation.location.geo") @(i+1)</a></li>
                    } else {
                      <li><a href="#organisations-map@i" data-toggle="tab">@Messages.get("organisation.location.geo") @(i+1)</a></li>
                    }
                  }
                  @if(!(parsedContent \ "address").asOpt[JsObject].isDefined) {
                    </ul>
                  }
                }
                @if((parsedContent \ "address").asOpt[JsObject].isDefined) {
                  <li><a href="#postal-address" data-toggle="tab">@Messages.get("organisation.location.postal")</a></li></ul>
                }
              <div class="tab-content">
                @if((parsedContent \ "location").asOpt[Seq[JsValue]].getOrElse(Seq()).length > 1
                  || ((parsedContent \ "location").asOpt[Seq[JsValue]].getOrElse(Seq()).length == 1
                     && (parsedContent \ "address").asOpt[JsObject].isDefined)) {
                  @for(i <- 0 to (parsedContent \ "location").asOpt[Seq[JsValue]].getOrElse(Seq()).length-1) {
                    @if(i == 0) {
                      <div id="organisations-map@i" class="tab-pane active organisations-map"></div>
                    } else {
                      <div id="organisations-map@i" class="tab-pane organisations-map"></div>
                    }
                  }
                  @if((parsedContent \ "address").asOpt[JsObject].isDefined) {
                     <div id="postal-address" class="tab-pane">
                       <p>
                         <table class='table table-striped table-condensed'>
                           @produceRow(Messages.get("organisation.location.postOfficeBoxNumber"), parsedContent \ "address" \ "postOfficeBoxNumber", false)
                           @produceRow(Messages.get("organisation.location.postalCode"), parsedContent \ "address" \ "postalCode", false)
                           @produceRow(Messages.get("organisation.location.addressLocality"), parsedContent \ "address" \ "addressLocality", false)
                         </table>
                       </p>
                     </div>
                  }
                } else {
                  <div id="organisations-map0" class="organisations-map"></div>
                }
              </div>
            </p>
          </div>
        }
        </div>
      </p>
    }

    <p>@Html(Messages.get("search.footer.api_text", routes.Application.get(id=id, format="json"), routes.Application.api()))</p>

}

@produceRow(name: String, value: JsValue, link: Boolean) = {
    @if(value.asOpt[JsValue].isDefined){
        @defining(value.as[String].substring(0,value.as[String].length())) { valueAsString =>
            <tr>
                <td class="field-label">
                    @name
                </td>
                <td class="field-value">
                    @if(!link) {
                        @valueAsString
                    } else {
                        <a href="@valueAsString">@valueAsString</a>
                    }
                </td>
            </tr>
        }
    }
}

@makeLocationDetails() = {
<link rel="stylesheet" href='@controllers.routes.Assets.at("stylesheets/leaflet.css")' />
<script src='@controllers.routes.Assets.at("javascripts/leaflet.js")'></script>
<script src='@controllers.routes.Assets.at("javascripts/Leaflet.MakiMarkers.js")'></script>
<script async type='text/javascript' src='@routes.Application.get(id, "js")'></script>
}
